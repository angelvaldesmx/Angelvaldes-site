document.addEventListener('DOMContentLoaded', async () => {
  const body = document.body,
        slideMenu = document.getElementById('slide-menu'),
        themeToggle = document.getElementById('theme-toggle'),
        featuredContainer = document.querySelector('.featured-blogs'),
        recentContainer = document.querySelector('.recent-blogs'),
        blogListModal = document.getElementById("blogListModal"),
        listModalTitle = document.getElementById("listModalTitle"),
        modalList = document.getElementById("modalList"),
        articleModal = document.getElementById('article-modal'),
        modalArticleTitle = document.getElementById('modal-article-title'),
        modalArticleImage = document.getElementById('modal-article-image'),
        modalArticleText1 = document.getElementById('modal-article-text'),
        modalArticleText2 = document.getElementById('modal-article-text-2'),
        modalArticleText3 = document.getElementById('modal-article-text-3');

  let allArticles = [];

  // ----------------------------
  // Obtener artículos (JSON local)
  // ----------------------------
  async function fetchArticles() {
    if(allArticles.length) return allArticles;
    try {
      const res = await fetch('/articulos.json');
      const data = await res.json();
      allArticles = [...data.destacados, ...data.recientes, ...data.semanales, ...data.mensuales];
      return allArticles;
    } catch(err) {
      console.error('Error cargando JSON:', err);
      return [];
    }
  }

  // ----------------------------
  // Crear tarjeta de artículo
  // ----------------------------
  function createArticleElement(article) {
    const div = document.createElement('div');
    div.className = 'blog-card';
    div.innerHTML = `
      ${article.image ? `<img src="${article.image}" alt="${article.title}" loading="lazy">` : ''}
      <h3>${article.title}</h3>
      <p>${article.subtitle || ''}</p>
      <a href="/blog/${article.slug}" class="read-more-link" data-article-id="${article.id}">Leer más</a>
    `;
    div.querySelector('.read-more-link').addEventListener('click', e => {
      e.preventDefault();
      openArticleModal(article);
      window.history.pushState({}, '', `/blog/${article.slug}`);
    });
    return div;
  }

  // ----------------------------
  // Abrir modal
  // ----------------------------
  function openArticleModal(article){
    modalArticleTitle.textContent = article.title;
    modalArticleImage.src = article.image || '';
    const p = article.content.split('\n\n');
    modalArticleText1.innerHTML = p[0] || '';
    modalArticleText2.innerHTML = p[1] || '';
    modalArticleText3.innerHTML = p[2] || '';

    document.getElementById('article-ads-container-top').innerHTML =
      `<iframe src="${article.adTop || 'about:blank'}" loading="lazy"></iframe>`;
    document.getElementById('article-ads-container-bottom').innerHTML =
      `<iframe src="${article.adBottom || 'about:blank'}" loading="lazy"></iframe>`;

    articleModal.classList.add('show');
    body.style.overflow = 'hidden';
  }

  // ----------------------------
  // Modal lista artículos
  // ----------------------------
  function openListModal(title,list){
    listModalTitle.textContent = title;
    modalList.innerHTML = '';
    list.forEach(item => {
      const li = document.createElement('li'),
            a = document.createElement('a');
      a.href = `/blog/${item.slug}`;
      a.textContent = item.title;
      a.addEventListener('click', e => {
        e.preventDefault();
        openArticleModal(item);
        window.history.pushState({}, '', `/blog/${item.slug}`);
      });
      li.appendChild(a);
      modalList.appendChild(li);
    });
    blogListModal.classList.add('show');
    body.style.overflow = 'hidden';
  }

  function closeModals(){
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
    body.style.overflow = 'auto';
  }

  function ajustarAds(){
    document.querySelectorAll('.ad-container').forEach(ad=>{
      ad.style.fontSize = window.innerWidth < 768 ? '12px' : window.innerWidth < 1030 ? '14px' : '16px';
    });
  }

  // ----------------------------
  // Tema
  // ----------------------------
  body.classList.add((localStorage.getItem('theme')||'light')+'-mode');
  themeToggle?.addEventListener('click', ()=>{
    if(body.classList.contains('light-mode')){
      body.classList.replace('light-mode','dark-mode');
      localStorage.setItem('theme','dark');
    } else {
      body.classList.replace('dark-mode','light-mode');
      localStorage.setItem('theme','light');
    }
  });

  // ----------------------------
  // Menú lateral
  // ----------------------------
  document.querySelectorAll('.slide-menu-button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      slideMenu.classList.toggle('is-active');
      body.classList.toggle('menu-open');
      btn.setAttribute('aria-expanded', slideMenu.classList.contains('is-active'));
    });
  });
  document.querySelectorAll('.slide-menu-close').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      slideMenu.classList.remove('is-active');
      body.classList.remove('menu-open');
    });
  });

  // ----------------------------
  // Cerrar modales
  // ----------------------------
  document.querySelectorAll('.modal').forEach(modal=>{
    modal.addEventListener('click', e => { if(e.target===modal) closeModals(); });
  });
  document.querySelectorAll('.close,.closeContent,.modal-close').forEach(btn=>{
    btn.addEventListener('click', ()=> closeModals());
  });

  window.addEventListener('resize', ajustarAds);
  window.addEventListener('load', ajustarAds);

  // ----------------------------
  // Renderizar artículos
  // ----------------------------
  const articles = await fetchArticles();
  articles.forEach(a=>{
    if(a.category==='destacados') featuredContainer.appendChild(createArticleElement(a));
    else if(a.category==='recientes') recentContainer.appendChild(createArticleElement(a));
  });

  ["openWeekly","openWeeklySidebar"].forEach(id=>{
    document.getElementById(id)?.addEventListener('click', async e=>{
      e.preventDefault(); 
      const data = await fetchArticles();
      openListModal("Blogs Semanales", data.filter(a=>a.category==='semanales'));
    });
  });
  ["openMonthly","openMonthlySidebar"].forEach(id=>{
    document.getElementById(id)?.addEventListener('click', async e=>{
      e.preventDefault(); 
      const data = await fetchArticles();
      openListModal("Blogs Mensuales", data.filter(a=>a.category==='mensuales'));
    });
  });

  // ----------------------------
  // Navegación SPA con pushState
  // ----------------------------
  document.body.addEventListener('click', e=>{
    const link = e.target.closest('.read-more-link');
    if(link){
      e.preventDefault();
      const article = allArticles.find(a=>a.id == link.dataset.articleId);
      if(article) openArticleModal(article);
      window.history.pushState({}, '', `/blog/${article.slug}`);
    }
  });

  window.addEventListener('popstate', ()=>{
    const slug = window.location.pathname.split('/blog/')[1];
    const article = allArticles.find(a => a.slug === slug);
    if(article) openArticleModal(article);
    else closeModals();
  });

  // Abrir artículo inicial si hay slug en URL
  const initialSlug = window.location.pathname.split('/blog/')[1];
  if(initialSlug){
    const art = articles.find(a => a.slug === initialSlug);
    if(art) openArticleModal(art);
  }
});