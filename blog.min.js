document.addEventListener('DOMContentLoaded', async () => {
  const body = document.body;
  const slideMenu = document.getElementById('slide-menu');
  const themeToggle = document.getElementById('theme-toggle');

  const featuredContainer = document.getElementById('featured');
  const recentContainer = document.getElementById('recent');

  const blogListModal = document.getElementById("blogListModal");
  const listModalTitle = document.getElementById("listModalTitle");
  const modalList = document.getElementById("modalList");

  const blogContentModal = document.getElementById("blogContentModal");
  const contentTitle = document.getElementById("contentTitle");
  const contentBody = document.getElementById("contentBody");

  const articleModal = document.getElementById('article-modal');
  const modalArticleTitle = document.getElementById('modal-article-title');
  const modalArticleImage = document.getElementById('modal-article-image');
  const modalArticleText1 = document.getElementById('modal-article-text');
  const modalArticleText2 = document.getElementById('modal-article-text-2');
  const modalArticleText3 = document.getElementById('modal-article-text-3');

  let allArticles = [];

  async function fetchArticles() {
    try {
      const res = await fetch('/articulos.json');
      return await res.json();
    } catch (err) {
      console.error('Error cargando JSON:', err);
      return { destacados: [], recientes: [], semanales: [], mensuales: [] };
    }
  }

  function createArticleElement(article) {
    const div = document.createElement('div');
    div.className = 'blog-card';
    div.innerHTML = `
      ${article.image ? `<img src="${article.image}" alt="${article.title}" loading="lazy">` : ''}
      <h3>${article.title}</h3>
      <p>${article.subtitle || ''}</p>
      <a href="#" class="read-more-link" data-article-id="${article.id}">Leer m√°s</a>
    `;
    div.querySelector('.read-more-link').addEventListener('click', e => {
      e.preventDefault();
      openArticleModal(article);
      history.pushState({ slug: article.slug }, article.title, `/articulos/${article.slug}`);
    });
    return div;
  }

  function openArticleModal(article) {
    modalArticleTitle.textContent = article.title;
    modalArticleImage.src = article.image || '';
    const p = article.content.split('\n\n');
    modalArticleText1.innerHTML = p[0] || '';
    modalArticleText2.innerHTML = p[1] || '';
    modalArticleText3.innerHTML = p[2] || '';
    articleModal.classList.add('show');
    body.style.overflow = 'hidden';
  }

  function openListModal(title, list) {
    listModalTitle.textContent = title;
    modalList.innerHTML = '';
    list.forEach(item => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `/articulos/${item.slug}`;
      a.textContent = item.title;
      a.addEventListener('click', e => {
        e.preventDefault();
        openContentModal(item);
        history.pushState({ slug: item.slug }, item.title, `/articulos/${item.slug}`);
      });
      li.appendChild(a);
      modalList.appendChild(li);
    });
    blogListModal.classList.add('show');
    body.style.overflow = 'hidden';
  }

  function openContentModal(article) {
    contentTitle.textContent = article.title;
    contentBody.innerHTML = article.content;
    blogContentModal.classList.add('show');
    body.style.overflow = 'hidden';
  }

  function closeModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
    body.style.overflow = 'auto';
  }

  // Slide Menu
  document.querySelectorAll('.slide-menu-button').forEach(btn => {
    btn.addEventListener('click', () => {
      slideMenu.classList.toggle('is-active');
      body.classList.toggle('menu-open');
      btn.setAttribute('aria-expanded', slideMenu.classList.contains('is-active'));
    });
  });
  document.querySelectorAll('.slide-menu-close').forEach(btn => {
    btn.addEventListener('click', () => {
      slideMenu.classList.remove('is-active');
      body.classList.remove('menu-open');
    });
  });

  // Modals
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', e => { if (e.target === modal) closeModals(); });
  });
  document.querySelectorAll('.close, .closeContent, .modal-close').forEach(btn => {
    btn.addEventListener('click', closeModals);
  });

  // Theme Toggle
  body.classList.add((localStorage.getItem('theme') || 'light') + '-mode');
  themeToggle?.addEventListener('click', () => {
    if (body.classList.contains('light-mode')) {
      body.classList.replace('light-mode', 'dark-mode');
      localStorage.setItem('theme', 'dark');
    } else {
      body.classList.replace('dark-mode', 'light-mode');
      localStorage.setItem('theme', 'light');
    }
  });

  // Load articles
  const data = await fetchArticles();
  allArticles = [...data.destacados, ...data.recientes, ...data.semanales, ...data.mensuales];
  allArticles.forEach(a => {
    if (a.category === 'destacados') featuredContainer.appendChild(createArticleElement(a));
    else if (a.category === 'recientes') recentContainer.appendChild(createArticleElement(a));
  });

  ["openWeekly","openWeeklySidebar"].forEach(id => {
    document.getElementById(id)?.addEventListener('click', async e => {
      e.preventDefault();
      const data = await fetchArticles();
      openListModal("Blogs Semanales", data.semanales);
    });
  });
  ["openMonthly","openMonthlySidebar"].forEach(id => {
    document.getElementById(id)?.addEventListener('click', async e => {
      e.preventDefault();
      const data = await fetchArticles();
      openListModal("Blogs Mensuales", data.mensuales);
    });
  });
});