document.addEventListener('DOMContentLoaded', async () => {
  const body=document.body,slideMenu=document.getElementById('slide-menu'),themeToggle=document.getElementById('theme-toggle');
  const featuredContainer=document.querySelector('.featured-blogs'),recentContainer=document.querySelector('.recent-blogs');
  const blogListModal=document.getElementById("blogListModal"),listModalTitle=document.getElementById("listModalTitle"),modalList=document.getElementById("modalList");
  const blogContentModal=document.getElementById("blogContentModal"),contentTitle=document.getElementById("contentTitle"),contentBody=document.getElementById("contentBody");
  const articleModal=document.getElementById('article-modal'),modalArticleTitle=document.getElementById('modal-article-title');
  const modalArticleImage=document.getElementById('modal-article-image');
  const modalArticleText1=document.getElementById('modal-article-text');
  const modalArticleText2=document.getElementById('modal-article-text-2');
  const modalArticleText3=document.getElementById('modal-article-text-3');

  let allArticles=[];

  async function fetchArticles(){
    try{const res=await fetch('/articulos.json');return await res.json();}catch(err){console.error('Error cargando JSON:',err);return {destacados:[],recientes:[],semanales:[],mensuales:[]};}
  }

  function createArticleElement(article){
    const div=document.createElement('div');
    div.className='blog-card';
    div.innerHTML=`${article.image?`<img src="${article.image}" alt="${article.title}" loading="lazy">`:''}<h3>${article.title}</h3><p>${article.subtitle||''}</p><a href="#" class="read-more-link" data-article-id="${article.id}">Leer más</a>`;
    div.querySelector('.read-more-link').addEventListener('click',e=>{e.preventDefault();openArticleModal(article);history.pushState({slug:article.slug},article.title,`/articulos/${article.slug}`);});
    return div;
  }

  function openArticleModal(article){
    modalArticleTitle.textContent=article.title;
    modalArticleImage.src=article.image||'';
    const p=article.content.split('\n\n');
    modalArticleText1.innerHTML=p[0]||'';modalArticleText2.innerHTML=p[1]||'';modalArticleText3.innerHTML=p[2]||'';
    articleModal.classList.add('show');
    body.style.overflow='hidden';
    updateMetaTags(article);
  }

  function openListModal(title,list){
    listModalTitle.textContent=title;
    modalList.innerHTML='';
    list.forEach(item=>{
      const li=document.createElement('li'),a=document.createElement('a');
      a.href=`/articulos/${item.slug}`;a.textContent=item.title;a.addEventListener('click',e=>{e.preventDefault();openContentModal(item);history.pushState({slug:item.slug},item.title,`/articulos/${item.slug}`);});
      li.appendChild(a);modalList.appendChild(li);
    });
    blogListModal.classList.add('show');body.style.overflow='hidden';
  }

  function openContentModal(article){contentTitle.textContent=article.title;contentBody.innerHTML=article.content;blogContentModal.classList.add('show');body.style.overflow='hidden';}
  function closeModals(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'));body.style.overflow='auto';}

  function updateMetaTags(article){
    document.querySelectorAll('.dynamic-meta').forEach(m=>m.remove());
    const metas=[{name:'description',content:article.summary||''},{name:'keywords',content:article.title},{property:'og:title',content:article.title},{property:'og:description',content:article.summary},{property:'og:image',content:article.image},{property:'og:url',content:window.location.href},{property:'og:type',content:'article'}];
    metas.forEach(m=>{const meta=document.createElement('meta');if(m.name)meta.name=m.name;if(m.property)meta.setAttribute('property',m.property);meta.content=m.content;meta.className='dynamic-meta';document.head.appendChild(meta);});
    const script=document.createElement('script');script.type='application/ld+json';script.className='dynamic-meta';
    script.textContent=JSON.stringify({"@context":"https://schema.org","@type":"NewsArticle","headline":article.title,"image":[article.image],"datePublished":article.pubDate||new Date().toISOString(),"author":{"@type":"Person","name":article.source||"Autor"},"description":article.summary||"","mainEntityOfPage":{"@type":"WebPage","@id":window.location.href}});
    document.head.appendChild(script);
  }

  function ajustarAds(){document.querySelectorAll('.ad-container').forEach(ad=>{ad.style.fontSize=window.innerWidth<768?'12px':window.innerWidth<1030?'14px':'16px';});}

  // Inicialización
  body.classList.add((localStorage.getItem('theme')||'light')+'-mode');
  themeToggle?.addEventListener('click',()=>{
    if(body.classList.contains('light-mode')){body.classList.replace('light-mode','dark-mode');localStorage.setItem('theme','dark');}
    else{body.classList.replace('dark-mode','light-mode');localStorage.setItem('theme','light');}
  });

  document.querySelectorAll('.slide-menu-button').forEach(btn=>{btn.addEventListener('click',()=>{slideMenu.classList.toggle('is-active');body.classList.toggle('menu-open');btn.setAttribute('aria-expanded',slideMenu.classList.contains('is-active'));});});
  document.querySelectorAll('.slide-menu-close').forEach(btn=>{btn.addEventListener('click',()=>{slideMenu.classList.remove('is-active');body.classList.remove('menu-open');});});

  document.querySelectorAll('.modal').forEach(modal=>{modal.addEventListener('click',e=>{if(e.target===modal)closeModals();});});
  document.querySelectorAll('.close,.closeContent,.modal-close').forEach(btn=>{btn.addEventListener('click',()=>closeModals());});

  window.addEventListener('resize',ajustarAds);window.addEventListener('load',ajustarAds);

  allArticles=[...((await fetchArticles()).destacados),...((await fetchArticles()).recientes),...((await fetchArticles()).semanales),...((await fetchArticles()).mensuales)];
  allArticles.forEach(a=>{if(a.category==='destacados')featuredContainer.appendChild(createArticleElement(a));else if(a.category==='recientes')recentContainer.appendChild(createArticleElement(a));});

  ["openWeekly","openWeeklySidebar"].forEach(id=>document.getElementById(id)?.addEventListener('click',e=>{e.preventDefault();openListModal("Blogs Semanales",(await fetchArticles()).semanales);}));
  ["openMonthly","openMonthlySidebar"].forEach(id=>document.getElementById(id)?.addEventListener('click',e=>{e.preventDefault();openListModal("Blogs Mensuales",(await fetchArticles()).mensuales);}));

  document.body.addEventListener('click',e=>{
    const link=e.target.closest('.read-more-link');
    if(link){e.preventDefault();const article=allArticles.find(a=>a.id==link.dataset.articleId);if(article)openArticleModal(article);history.pushState({slug:article.slug},article.title,`/articulos/${article.slug}`);}
  });

  window.addEventListener('popstate',()=>{const slug=history.state?.slug;if(slug){const article=allArticles.find(a=>a.slug==slug);if(article)openArticleModal(article);else closeModals();}else closeModals();});
});